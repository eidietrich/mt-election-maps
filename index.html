<!DOCTYPE html>
<html>
<head>
  <title>Mapping Montana's politics</title>
  <link rel="stylesheet" type="text/css" href="./../css/bootstrap.css">
  <style>
    .label {
      font: 10px sans-serif;
      fill: white;
      text-anchor: middle;
    }
    .districts {
      /*fill: #bbb;*/
      stroke: #666;
      border-width: 1px;
    }
    .circle {
      opacity: 0.9;
    }
    .grid line{
      stroke: #bbb;
      opacity: 0.8;
    }
    #viz-container {
      margin: auto;
      padding-left: 10px
      padding-right: 10px;
      width: 100%;
      max-width: 1000px;
    }

  </style>
</head>
<body>
  <div id="viz-container">
    <div id="chart1"></div>
    <div id="chart2"></div>
    <div id="chart3"></div>
    <div id="chart4"></div>
  </div>

  <script src="js/d3.min.js"></script>
  <script src="js/Choropleth.js"></script>
  <script src="js/CircleShadeMap.js"></script>
  <script src="js/BarGraph.js"></script>
  <script src="js/OpposingBarGraph.js"></script>
  <script src="js/DistrictArray.js"></script>
  <script src="js/Cartogram.js"></script>
  <script src="js/ColorMap.js"></script>
  <script type="text/javascript">
    // Universal functions
    var globals = {
      scale: d3.scaleLinear().range([0,1600]),
      voterScale: function(number){
        // returns radius for proportional area, I think
        return Math.sqrt(this.scale(number));
      },
      colorScale: d3.scaleLinear()
        .domain([0,0.35,0.5,0.65,1])
        .range(["#b2182b","#d6604d","#756bb1","#4393c3","#2166ac"])
        .interpolate(d3.interpolateLab),
      colorByParty: d3.scaleOrdinal()
        .domain(["R","D"])
        .range(["#b2182b", "#2166ac"])
        .unknown("green"),
      colorByRegion: d3.scaleOrdinal()
        .domain(['Kalispell / Whitefish','Great Falls', 'Billings','Bozeman','Helena','Missoula','Butte / Anaconda'])
        .range(['#b2df8a','#33a02c','#fb9a99','#fdbf6f','#ff7f00','#cab2d6','#6a3d9a'])
        .unknown("#bbb"),
      format: d3.format(".0%")
    };

    // Queue up multiple data files to load
    d3.queue()
      // Geodata
      .defer(d3.json, './../geodata/mt_counties.geojson')
      .defer(d3.json, './../geodata/gc_precincts.geojson')
      .defer(d3.json, './../geodata/mt_senate_districts.geojson')
      .defer(d3.json, './../geodata/mt_house_districts.geojson')
      .defer(d3.json, './../geodata/sen-carto.geojson')
      // Other data
      .defer(d3.json, './../data/2012_election_county_data.json')
      .defer(d3.json, './../data/fake_election_precincts.json')
      .defer(d3.json, './../data/districts.json')
      .defer(d3.csv, './../data/mt-senate.csv')
      .defer(d3.csv, './../data/mt-house.csv')
      .await(main);

    function main (error,
      // Geodata
      counties, gcPrecincts, mtSenDistricts, mtHouseDistricts, mtSenCartoDisplay,
      // Other data
      countyVotes, precinctVotes, districts, mtSenData, mtHouseData
      ) {

      // var cartogram = new ColorMap({
      //   'element': document.querySelector('#chart1'),
      //   'data': bindToGeoJson(mtSenCartoDisplay, mtSenData, 'sd', 'number',
      //       ['district', 'incum_party', 'district_label']),
      //   'aspectRatio': .6, // h / w
      // });

      // var senateMap = new ColorMap({
      //   'element': document.querySelector('#chart2'),
      //   'data': bindToGeoJson(mtSenDistricts, mtSenData, 'number', 'number',
      //       ['district', 'incum_party', 'district_label']),
      //   'aspectRatio': .6
      // })

      // var houseMap = new ColorMap({
      //   'element': document.querySelector('#chart3'),
      //   'data': bindToGeoJson(mtHouseDistricts, mtHouseData, 'number', 'number',
      //       ['district', 'incum_party', 'district_label']),
      //   'aspectRatio': .6
      // })

      // var districts = new DistrictArray({
      //   'element': document.querySelector('#chart4'),
      //   'data': districts,
      //   'height': 1500
      // });

      // var countyBar = new BarGraph({
      //   'element': document.querySelector('#chart1'),
      //   'data': prepForBar(countyVotes, 'reg_voters', ['tester_votes', 'rehberg_votes','cox_votes']),
      //   'height': 100
      // })
      // var countyOpposing = new OpposingBarGraph({
      //   'element': document.querySelector('#chart2'),
      //   'data': prepForBar(countyVotes, 'reg_voters', ['tester_votes', 'rehberg_votes','cox_votes']),
      //   'height': 100
      // })

      // var countiesMerged = mergeData(counties, countyVotes, 'NAME', {
      //   'voters': 'reg_voters',
      //   'votesCast': 'votes_cast',
      //   'toPlot': 'tester_votes'
      // });
      // var countyMap = new Choropleth({
      //     'element': document.querySelector('#chart2'),
      //     'data': countiesMerged,
      //     'height': 400
      //   });

      // var precinctsMerged = mergeData(gcPrecincts, precinctVotes, 'PRECINCT', {
      //   'voters': 'VOTERS',
      //   'votesCast': 'VOTERS',
      //   'toPlot': 'A_VOTES'
      // })
      // var gcPrecinctsMap = new Choropleth({
      //     'element': document.querySelector('#chart2'),
      //     'data': precinctsMerged,
      //     'height': 400
      //   });

      // OLD -------
      // var map = new CircleShadeMap({
      //     'element': '#circleshade',
      //     'data': {
      //       'districts': counties,
      //       'votes': countyVotes
      //     },
      //     'width': 500,
      //     'height': 400
      //   }, globals);

      // For resizing
      d3.select(window).on('resize', function(){
        cartogram.draw();
        senateMap.draw();
      })
    }

    function mergeData (geoJson, joinData, joinKey, dims) {
      // Takes geojson spatial data object and performs a left merge from joinData array
      // Assumes geojson.properties has "center_lon" and "center_lat" centroid fields
      // Returns merged geojson object

      // To look at: Add filtering here?

      var outGeoJson = geoJson;

      // shift centroid coordinates to centerCoords array
      // NOTES: THIS ISN'T REALLY NECESSARY b/c of D3's "path.centroid" function
      outGeoJson.features.forEach(function(district){
        district.properties.centerCoords = [+district.properties["center_lon"], +district.properties["center_lat"]];
      });

      // Perform merge
      outGeoJson.features.forEach(function(district){
        joinData.forEach(function(d){
          if (d[joinKey] == district.properties[joinKey]){
            district.properties.voters = d[dims.voters];
            district.properties.votesCast = d[dims.votesCast];
            district.properties.votesForA = d[dims.toPlot];
          }
        });
      });

      return outGeoJson;
    }
    function bindToGeoJson(geoJson, data, geoKey, dataKey, includeCols){
      // Similar to mergeData -- binds "flat" json data (e.g. from a .csv import) to a geoJson object
      // include cols is an array of fields from the merging data to include

      var combined = geoJson;
      combined.features.forEach(function(feature){
        data.forEach(function(row){
          if (String(row[dataKey]) === String(feature.properties[geoKey])){
            includeCols.forEach(function(col){
              feature.properties[col] = row[col];
            });
          }
        });
      });
      return combined;
    }
    function prepForBar (data, maxDim, issueArray) {
      // THIS IS HALF-FUNCTIONAL
      // Use d3 rollup here?
      // Produce object for BarGraph class to plot
      // Form of:
      // var preppedData = {
      //   max: 100,
      //   results: [
      //     {'name': 'issueA', 'votes': 45},
      //     {'name': 'issueB', 'votes': 34},
      //     {'name': 'issueC', 'votes': 5}
      //   ]
      // }

      // For summing values
      var sum = function(items, prop){
        return items.reduce(function(a, b){
          return a + b[prop];
        }, 0);
      };

      var preppedData = {
        'max': null,
        'results': []
      };

      preppedData.max = sum(data, maxDim);
      issueArray.forEach(function(name){
        preppedData.results.push({
          "name": name,
          "votes": sum(data, name)});
      })
      return preppedData;
    }

  </script>
</html>