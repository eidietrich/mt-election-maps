<!DOCTYPE html>
<html>
<head>
  <title>Mapping Montana's politics</title>
  <link rel="stylesheet" type="text/css" href="./../css/bootstrap.css">
  <link rel="stylesheet" type="text/css" href="./../css/main.css">
</head>
<body>
  <ul class="nav nav-tabs"">
    <li role="presentation" id="home" onclick="handleTabClick(this);" class="active"><a href="#">Overview</a></li>
    <li role="presentation" id="mtGov" onclick="handleTabClick(this);" class="active"><a href="#">Montana Governor</a></li>
    <li role="presentation" id="usRep" onclick="handleTabClick(this);"><a href="#">US Rep</a></li>
    <li role="presentation" id="usPresident" onclick="handleTabClick(this);"><a href="#">US Presidency</a></li>
    <li role="presentation" id="mtSenate" onclick="handleTabClick(this);"><a href="#">Montana Senate</a></li>
    <li role="presentation" id="mtHouse" onclick="handleTabClick(this);"><a href="#">Montana House</a></li>
    <li role="presentation" id="medMarijuana" onclick="handleTabClick(this);"><a href="#">I-182</a></li>
    <li role="presentation" id="antiTrapping" onclick="handleTabClick(this);"><a href="#">I-777</a></li>
  </ul>
  <div id="viz-container">
    <div id="chart1" class="chart-container"></div>
    <div id="chart2" class="chart-container"></div>
    <div id="chart3" class="chart-container"></div>
    <div id="chart4" class="chart-container"></div>
  </div>

  <!-- Libraries -->
  <script src="js/d3.min.js"></script>
  <script src="js/jquery-3.1.1.min.js"></script>

  <!-- Interface scripts -->
  <script src="js/data-wrangling.js"></script>
  <script src="js/globals.js"></script>
  <script src="js/Dashboard.js"></script>
  <script src="js/Panel.js"></script>

  <!-- Component scripts -->
  <script src="js/CircleShadeMap.js"></script>
  <script src="js/BarGraph.js"></script>
  <script src="js/OpposingBarGraph.js"></script>
  <script src="js/DistrictArray.js"></script>
  <script src="js/ColorMap.js"></script>
  <script src="js/Text.js"></script>
  <script src="js/TableByCounty.js"></script>


  <script type="text/javascript">

  var main = function(){
    // Main function, called at bottom of file here
    // dashboard = new Dashboard(dataFiles, dataJoins, panels.mtGov);

    // Test
    dashboard = new Dashboard(dataFiles, dataJoins, panels['home']);
  }

  var renderPane = function(paneId){
    // clear contents of chart-container divs and render pane with given id
    $('.chart-container').empty();
    dashboard.render(panels[paneId]);
  }

  var handleTabClick = function(e){
    // Adjust tab bar classses
    $(e).addClass('active');
    $(e).siblings().removeClass('active');
    renderPane(e.id);
  }

  var dashboard;

  // Supplemental info (e.g. party, incumbency)
  // TODO: Look at breaking this out into a separate file
  var extraCandidateInfo = {
    'mtGov': {
      'BULLOCK': {'party': 'D', 'incumbent': 'yes'},
      'GIANFORTE': {'party': 'R', 'incumbent': 'no'},
      'DUNLAP': {'party': 'L', 'incumbent': 'no'},
    },
    'usRep' : {
      'ZINKE' : {'party': 'R', 'incumbent': 'yes'},
      'JUNEAU': {'party': 'D', 'incumbent': 'no'},
      'BRECKENRIDGE' : {'party': 'L', 'incumbent': 'no'},
    },
    'usPresident': {
      'CLINTON': {'party': 'D', 'incumbent': 'no'},
      'TRUMP': {'party': 'R', 'incumbent': 'no'},
      'JOHNSON': {'party': 'L', 'incumbent': 'no'},
      'STEIN': {'party': 'G', 'incumbent': 'no'},
      'DE LA FUENTE': {'party': null, 'incumbent': 'no'},
    }
  }

  // Array of files for Dashboard to pull in
  var dataFiles = [
    // Geodata
    {'name': 'mtSenDistricts', 'file': './../geodata/mt_senate_districts.geojson', 'loader': d3.json},
    {'name': 'mtHouseDistricts', 'file': './../geodata/mt_house_districts.geojson', 'loader': d3.json},
    {'name': 'mtCounties', 'file': './../geodata/mt_counties.geojson', 'loader': d3.json},
    // Add: Senate cartogram
    // Add: House cartogram

    // Static data
    {'name': 'mtSenData', 'file': './../data/mt-senate.csv', 'loader': d3.csv},
    {'name': 'mtHouseData', 'file': './../data/mt-house.csv', 'loader': d3.csv},

    // Live data
    // TODO: Switch this from test data
    {'name': 'races', 'file': './test/livedata-byrace-novotes.json', 'loader': d3.json},
    {'name': 'counties', 'file': './test/livedata-bycounty-novotes.json', 'loader': d3.json},

  ];
  var dataJoins = [
    // Array of data processing functions for Dashboard to run on data refresh
    // See data-wrangling.js for function documentation
    {
      'name': 'mtSenDistSenate',
      'functName': bindFlatToGeoJson,
      'geoData': 'mtSenDistricts', 'joinData': 'mtSenData',
      'otherArgs': ['number','number', ['district', 'incum_party', 'district_label']]
    },
    {
      'name': 'mtHouseDistHouse',
      'functName': bindFlatToGeoJson,
      'geoData': 'mtHouseDistricts', 'joinData': 'mtHouseData',
      'otherArgs': ['number','number', ['district', 'incum_party', 'district_label']]
    },
    {
      // Should add race-keyed results entries to geoJson properties field
      'name': 'mtResultsByCounty',
      'functName': mergeResultsByCounty,
      'geoData': 'mtCounties', 'joinData': 'counties',
      'otherArgs': [['mtGov','usPresident','usRep','antiTrapping','medMarijuana']]
    }
  ];
  // var testPanel = {
  //   'name': 'panel1',
  //   'design': [
  //     {'id': 'chart1', 'Template': TableByCounty, 'dataVar': 'usRepByCounty',
  //     'props': {
  //       'extraCandidateInfo': extraCandidateInfo['usRep']
  //     } },
  //   ]
  // };

  /*

  Each panel object gives Dashboard.js >> Panel.js a list of components to render
  'id' is the id for the anchor the component will attach to
  'Template' refers to the component class used to create the chart (or text element)
  'dataVar' is a string used to reference data stored in Dashboard.data. It should match the name of of either a directly loaded data file in dataFiles above, or a name in dataJoins
  'data' (optional) is a way to pass data directly into the component via props.data (may not work currently)
  'props' object hands the Template constructor additional properties

  */

  var panels = {
    'home': { // TODO: Make this an overview of various races
      'name': 'home',
      'design': [


      ]
    },
    'mtGov': {
      'name': 'mtGov',
      'design': [
        {'id': 'chart1', 'Template': ColorMap, 'dataVar': 'mtResultsByCounty',
          'props': {
            'aspectRatio': 0.6,
            'colorBy': function(d) { return 'green'; }
          }
        },
        {'id': 'chart2', 'Template': TableByCounty, 'dataVar': 'mtResultsByCounty',
        'props': {
          'race': 'mtGov',
          'extraCandidateInfo': extraCandidateInfo['mtGov'],
          'title': "Title here",
          'cutline': "This is a cutline"
        } },
      ]
    },
    'usRep': {
      'name': 'usRep',
      'design': [
        {'id': 'chart2', 'Template': ColorMap, 'dataVar': 'mtCounties',
        'props': {
          'aspectRatio': 0.6,
        } },
        {'id': 'chart3', 'Template': TableByCounty, 'dataVar': 'mtResultsByCounty',
        'props': {
          'race': 'usPresident',
          'extraCandidateInfo': extraCandidateInfo['usRep'],
          'title': "Title here",
          'cutline': "This is a cutline"
        } },
        // {'id': 'chart2', 'Template': ColorMap, 'dataVar': 'mtCartoUsHouse' }
      ]
    },
    'usPresident': {
      'name': 'usPresident',
      'design': [
        {'id': 'chart2', 'Template': ColorMap, 'dataVar': 'mtCounties',
        'props': {
          'aspectRatio': 0.6,
        } },
        {'id': 'chart3', 'Template': TableByCounty, 'dataVar': 'mtResultsByCounty',
        'props': {
          'race': 'usPresident',
          'extraCandidateInfo': extraCandidateInfo['usPresident'],
          'title': "Title here",
          'cutline': "This is a cutline"
        } },
        // {'id': 'chart2', 'Template': ColorMap, 'dataVar': 'mtCartoUsPres' }
      ]
    },
    'mtSenate': {
      'name': 'mtSenate',
      'design': [
        // MT Senate control
        {'id': 'chart1', 'Template': ColorMap, 'dataVar': 'mtSenDistSenate',
        'props': {
          'aspectRatio': 0.6,
          'colorBy': function(d) { return globals.colorByParty(d.properties.incum_party) },
          // 'featureLabel': function(d) { return d.properties.district; },
          }
        },
        // {'id': 'chart2', 'Template': ColorMap, 'dataVar': 'mtCounties' }
      ]
    },
    'mtHouse': {
      'name': 'mtHouse',
      'design': [
        // MT house control
        {'id': 'chart1', 'Template': ColorMap, 'dataVar': 'mtHouseDistHouse',
        'props': {
          'aspectRatio': 0.6,
          'colorBy': function(d) { return globals.colorByParty(d.properties.incum_party) },
          // 'featureLabel': function(d) { return d.properties.district; },
        }
      }
        // {'id': 'chart2', 'Template': ColorMap, 'dataVar': 'mtHouseCartoHouse' }
        // Add table
      ]
    },
    'medMarijuana': {
      'name': 'medMarijuana',
      'design': [
        {'id': 'chart2', 'Template': ColorMap, 'dataVar': 'mtCounties',
         'props': {
          'aspectRatio': 0.6,
          }
        },
        {'id': 'chart3', 'Template': TableByCounty, 'dataVar': 'mtResultsByCounty',
          'props': {
            'race': 'medMarijuana',
            'extraCandidateInfo': {},
            'title': "Title here",
            'cutline': "This is a cutline"
          }
        },
        // {'id': 'chart2', 'Template': ColorMap, 'dataVar': 'mtCartoMarij' }
      ]
    },
    'antiTrapping': {
      'name': 'antiTrapping',
      'design': [
        {'id': 'chart2', 'Template': ColorMap, 'dataVar': 'mtCounties',
         'props': {
          'aspectRatio': 0.6,
          }
        },
        {'id': 'chart3', 'Template': TableByCounty, 'dataVar': 'mtResultsByCounty',
          'props': {
            'race': 'antiTrapping',
            'extraCandidateInfo': {},
            'title': "Title here",
            'cutline': "This is a cutline"
          }
        },
        // {'id': 'chart2', 'Template': ColorMap, 'dataVar': 'mtCartoTrapping' }
        // Tabulated
      ]
    }
  }

  main();

    // // Queue up multiple data files to load
    // d3.queue()
    //   // Geodata
    //   .defer(d3.json, './../geodata/mt_counties.geojson')
    //   .defer(d3.json, './../geodata/gc_precincts.geojson')
    //   .defer(d3.json, './../geodata/mt_senate_districts.geojson')
    //   .defer(d3.json, './../geodata/mt_house_districts.geojson')
    //   .defer(d3.json, './../geodata/sen-carto.geojson')
    //   // Other data
    //   .defer(d3.json, './../data/2012_election_county_data.json')
    //   .defer(d3.json, './../data/fake_election_precincts.json')
    //   .defer(d3.json, './../data/districts.json')
    //   .defer(d3.csv, './../data/mt-senate.csv')
    //   .defer(d3.csv, './../data/mt-house.csv')
    //   .await(main);

    // function main (error,
    //   // Geodata
    //   counties, gcPrecincts, mtSenDistricts, mtHouseDistricts, mtSenCartoDisplay,
    //   // Other data
    //   countyVotes, precinctVotes, districts, mtSenData, mtHouseData
    //   ) {

      // var comboData = bindToGeoJson(mtSenDistricts, mtSenData, 'number', 'number', ['district', 'incum_party', 'district_label']);
      // var comboData2 = bindToGeoJson(mtHouseDistricts, mtHouseData, 'number', 'number', ['district', 'incum_party', 'district_label']);
      // Panel(
      //   [
      //     {'id': 'senateMap', 'Template': ColorMap, 'data': comboData },
      //     {'id': 'senateMap2', 'Template': ColorMap, 'data': comboData2 }
      //   ]
      // );

      // var cartogram = new ColorMap({
      //   'element': document.querySelector('#chart1'),
      //   'data': bindToGeoJson(mtSenCartoDisplay, mtSenData, 'sd', 'number',
      //       ['district', 'incum_party', 'district_label']),
      //   'aspectRatio': .6, // h / w
      // });

      // var senateMap = new ColorMap({
      //   'element': document.querySelector('#chart1'),
      //   'data': bindToGeoJson(mtSenDistricts, mtSenData, 'number', 'number',
      //       ['district', 'incum_party', 'district_label']),
      //   'aspectRatio': .6
      // })

      // var houseMap = new ColorMap({
      //   'element': document.querySelector('#chart3'),
      //   'data': bindToGeoJson(mtHouseDistricts, mtHouseData, 'number', 'number',
      //       ['district', 'incum_party', 'district_label']),
      //   'aspectRatio': .6
      // })

      // var districts = new DistrictArray({
      //   'element': document.querySelector('#chart4'),
      //   'data': districts,
      //   'height': 1500
      // });

      // var countyBar = new BarGraph({
      //   'element': document.querySelector('#chart1'),
      //   'data': prepForBar(countyVotes, 'reg_voters', ['tester_votes', 'rehberg_votes','cox_votes']),
      //   'height': 100
      // })
      // var countyOpposing = new OpposingBarGraph({
      //   'element': document.querySelector('#chart2'),
      //   'data': prepForBar(countyVotes, 'reg_voters', ['tester_votes', 'rehberg_votes','cox_votes']),
      //   'height': 100
      // })

      // var countiesMerged = mergeData(counties, countyVotes, 'NAME', {
      //   'voters': 'reg_voters',
      //   'votesCast': 'votes_cast',
      //   'toPlot': 'tester_votes'
      // });
      // var countyMap = new Choropleth({
      //     'element': document.querySelector('#chart3'),
      //     'data': countiesMerged,
      //     'height': 400
      //   });

      // var precinctsMerged = mergeData(gcPrecincts, precinctVotes, 'PRECINCT', {
      //   'voters': 'VOTERS',
      //   'votesCast': 'VOTERS',
      //   'toPlot': 'A_VOTES'
      // })
      // var gcPrecinctsMap = new Choropleth({
      //     'element': document.querySelector('#chart2'),
      //     'data': precinctsMerged,
      //     'height': 400
      //   });

      // OLD -------
      // var map = new CircleShadeMap({
      //     'element': '#circleshade',
      //     'data': {
      //       'districts': counties,
      //       'votes': countyVotes
      //     },
      //     'width': 500,
      //     'height': 400
      //   }, globals);

    //   // For resizing
    //   d3.select(window).on('resize', function(){
    //   })
    // }
  </script>
</html>